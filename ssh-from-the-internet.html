<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      SSH from the internet without port forwarding &middot; Nevin's Blog
    
  </title>

  
  <link rel="canonical" href="http://localhost:4000/ssh-from-the-internet">
  

  <link rel="stylesheet" href="http://localhost:4000/public/css/poole.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/syntax.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="http://localhost:4000/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/atom.xml">

  
</head>


  <body class="theme-base-08">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A little space on the internet for <a href='https://nevinpjohn.in' target='_blank'>Nevin</a> to scribble tech stuff and hopefully more if time permits! Made by <a href='https://twitter.com/nevinjohn13' target='_blank'>@nevinjohn13</a>.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="http://localhost:4000/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="http://localhost:4000/about/">About</a>
        
      
    
      
    

    <a class="sidebar-nav-item" href="/archive/v1.1.0.zip">Download</a>
    <a class="sidebar-nav-item" href="">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.1.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2022. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Nevin's Blog</a>
            <small>lets talk tech!</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">SSH from the internet without port forwarding</h1>
  <span class="post-date">01 Jul 2022</span>
  <p>If you do not want to open ports on your network but want to ssh from the internet you could use Cloudflare Access to achieve this.</p>

<p><img src="/assets/images/cloudflare0.png" alt="Cloudflare Access" title="Zero Trust" /></p>

<h2 id="create-app-on-cloudflare-access">create App on Cloudflare Access</h2>

<p>Head to the Zero Trust dashboard to create a new application. Select the Applications page from the sidebar. Click <strong>Add application</strong>.</p>

<p>Select <em>Self Hosted</em></p>

<p><img src="/assets/images/cloudflare1.png" alt="Cloudflare Access" title="Add an application" /></p>

<p>Enter the <em>Application name</em> and add the subdomain:</p>

<p><img src="/assets/images/cloudflare2.png" alt="Cloudflare Access" title="Application name" /></p>

<p>Edit the App Policy to allow only the email address that you would like to authenticate:</p>

<p><img src="/assets/images/cloudflare3.png" alt="Cloudflare Access" title="Restrict to specific emails" /></p>

<p><strong><em>That’s it!</em></strong></p>

<h2 id="install-cloudflared-on-the-origin-server">install cloudflared on the origin server</h2>
<p>Cloudflare Tunnel creates a secure, outbound-only, connection between the origin server and Cloudflare’s network. With this, you can lock down any externally exposed points of ingress which means no open ports. So, now we want to configure the tunnel on the origin server.</p>

<p>For that, grab the package from <a href="https://github.com/cloudflare/cloudflared/releases" target="_blank">Github</a></p>

<p>Install the downloaded deb (in case if it is a Debian derivative):</p>

<p><code class="language-plaintext highlighter-rouge">sudo dpkg -i ./cloudflared.deb</code></p>

<p>Run the following command on the server to authenticate cloudflared into your Cloudflare account.</p>

<p><code class="language-plaintext highlighter-rouge">cloudflared tunnel login</code></p>

<p><em>cloudflared</em> on the headless server will let you copy the URL from the command-line output so that you could visit the URL in a browser on any machine and authenticate.</p>

<h2 id="creating-the-tunnel">creating the tunnel</h2>

<p><code class="language-plaintext highlighter-rouge">cloudflared tunnel create &lt;tunnel name&gt;</code></p>

<p>This will create a tunnel for you and output the relevant details to proceed to the next step:</p>

<p>Tunnel credentials written to <em>/home/user/.cloudflared/ce347-ewr-rbweb-b1b.json</em>. <em>cloudflared</em> chose this file based on where your origin certificate was found. Keep this file secret. To revoke these credentials, delete the tunnel.</p>

<p>Created tunnel <code class="language-plaintext highlighter-rouge">&lt;tunnel name&gt; with id &lt;unique id&gt;</code></p>

<p>Create a YAML file that cloudflared can reach. By default, cloudflared will look for the file in the same folder where cloudflared has been installed.</p>

<p><code class="language-plaintext highlighter-rouge">nano ~/.cloudflared/config.yml</code></p>

<p>Next, configure the Tunnel, replacing the example ID below with the unique ID of the Tunnel created above. Additionally, replace the hostname in this example with the hostname of the application configured with Cloudflare Access.</p>

<p><em>tunnel</em>: <code class="language-plaintext highlighter-rouge">6ff42ae2-id-demo-unique-31cid1551ef</code><br />
<em>credentials-file</em>: <code class="language-plaintext highlighter-rouge">/home/user/.cloudflared/6ff42ae2-765d-4adf-8112-31c55c1551ef.json</code></p>

<p>ingress:</p>
<ul>
  <li><em>hostname</em>: <code class="language-plaintext highlighter-rouge">ssh.yourdomain.com</code></li>
  <li>service: <code class="language-plaintext highlighter-rouge">ssh://localhost:&lt;ssh port&gt;</code></li>
  <li>service: <code class="language-plaintext highlighter-rouge">http_status:404</code></li>
</ul>

<p>You can now create a DNS record that will route traffic to this Tunnel. Multiple DNS records can point to a single Tunnel and will send traffic to the service configured as long as the hostname is defined with an ingress rule.</p>

<p>Navigate to <a href="https://dash.cloudflare.com">https://dash.cloudflare.com</a> and choose the hostname where you want to create a Tunnel. This should match the hostname of the Access policy. Click <strong>+ Add record</strong>.</p>

<p>Select <strong>CNAME</strong> as the record type. For the target, input the ID of your Tunnel followed by cfargotunnel.com. In this example, the target would be:</p>

<p><strong>&lt;unique id&gt;</strong><em>.cfargotunnel.com</em></p>

<h2 id="run-cloudflared-as-a-service">run cloudflared as a service</h2>

<p>I use linux so, in this article I will explain how to do it via systemctl.</p>

<p><code class="language-plaintext highlighter-rouge">sudo mv /home/user/.cloudflared/config.yml /etc/cloudflared/</code><br />
<code class="language-plaintext highlighter-rouge">cloudflared service install</code><br />
<code class="language-plaintext highlighter-rouge">sudo systemctl enable cloudflared</code></p>

<p>finally…</p>

<p><code class="language-plaintext highlighter-rouge">sudo systemctl start cloudflared</code></p>

<h2 id="ssh-ing-from-a-browser-on-the-client">SSH-ing from a browser on the client</h2>

<p>Cloudflare can render an SSH client in your browser.</p>

<p>To enable, navigate to the application page of the Access section in the Zero Trust dashboard. Click <strong>Edit</strong> and select the Settings tab. In the <strong><em>cloudflared settings card</em></strong>, select <strong><em>SSH</em></strong> from the <strong><em>Browser Rendering</em></strong> drop-down menu.</p>

<p>Once enabled, when users authenticate and visit the URL of the application, Cloudflare will render a terminal in their browser.</p>

<p><img src="/assets/images/cloudflare4.png" alt="Cloudflare Access" title="SSH from browser terminal" /></p>

<h3 id="thank-you"><strong><em>Thank you!</em></strong></h3>

</div>



      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
